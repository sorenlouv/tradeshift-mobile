app.controller("ActivityController",["$scope","$routeParams","angularFire","$rootScope","helpers","documentService",function(e,t,n,r,i,s){"use strict";var o=t.company_id,u=r.activeUser.company,a=i.getActivityId(r.activeUser.company,o),f=new Firebase(r.fireBaseUrl+"/companies/"+o),l=new Firebase(r.fireBaseUrl+"/companies/"+u+"/products"),c=new Firebase(r.fireBaseUrl+"/feeds/"+a),h=new Firebase(r.fireBaseUrl+"/users/");e.passiveCompany={};e.feed={};e.products={};e.users={};e.selectedPrice=0;e.activeUser=r.activeUser;e.clickedActivity={};e.selectLinesForInvoiceMode=!1;e.selectedLineIds=[];var p=null;n(f,e,"passiveCompany");n(c,e,"feed");n(l,e,"products");n(h,e,"users");e.addItem=function(){$(".pickers").show()};e.hidePickers=function(){$(".product-picker").hide();$(".select-picker").hide();$(".newProduct-picker").hide();$(".lineActions-picker").hide();$(".edit-picker").hide();$(".pickers").hide();e.newActivity=null};e.addProduct=function(){$(".product-picker").show()};e.showAddNewProduct=function(){$(".newProduct-picker").show()};var d=function(){var t=[];_.each(e.feed.lines,function(e,n){e.user===r.activeUser.id&&t.push(n)});return t};e.clickSelectLinesForInvoice=function(){e.selectLinesForInvoiceMode=!0;e.selectedLineIds=d();e.hidePickers()};e.getSelectedLinesTotal=function(){var t=0;_.each(e.selectedLineIds,function(n){var r=e.feed.lines[n];t+=r.product.quantity*r.product.custom_price});return t};e.getTotal=function(){var t=0,n=e.feed.lines;_.each(n,function(e){t+=e.product.quantity*e.product.custom_price});return t};e.generateInvoice=function(){var t=c.child("invoices").push();_.each(e.selectedLineIds,function(n){var r=e.feed.lines[n];t.push(r,function(a){c.child("lines").child(n).remove(function(){s.getUuid({invoice:e.feed.invoices[t.name()],senderCompany:i.getCompany(u),receiverCompany:i.getCompany(o)}).success(function(){})});e.selectLinesForInvoiceMode=!1;e.selectedLineIds=[]})})};e.setProduct=function(t){e.newActivity={user:r.activeUser.id,description:"",product:angular.copy(t)};$(".select-picker").show()};e.setCustomPrice=function(t,n){typeof e.newActivity!="undefined"&&e.newActivity!==null?e.newActivity.product.custom_price=t:e.clickedLine.product.custom_price=t};e.setQuantity=function(t){typeof e.newActivity!="undefined"&&e.newActivity!==null?e.newActivity.product.quantity=t:e.clickedLine.product.quantity=t};e.saveNewActivity=function(){c.child("lines").push(e.newActivity);e.hidePickers()};e.clickLine=function(t){if(e.selectLinesForInvoiceMode){e.feed.lines[t].user!==r.activeUser.id&&console.log("You can only select your own lines");var n=e.selectedLineIds.indexOf(t);n>-1?e.selectedLineIds.splice(n,1):e.selectedLineIds.push(t)}else{p=t;e.clickedLine=angular.copy(e.feed.lines[t]);$(".pickers").show();$(".lineActions-picker").show()}};e.addNewProduct=function(){l.push({title:$('.newProduct input[name="title"]').val(),price:$('.newProduct input[name="price"]').val(),currency:$('.newProduct input[name="currency"]').val(),tax:$('.newProduct input[name="tax"]').val()});$(".newProduct input").val("");$(".newProduct-picker").hide()};e.showEdit=function(){$(".edit-picker").show()};e.postComment=function(){var e=$(".comment-form textarea").val();c.child("lines").child(p).child("comments").push({comment:e,type:"comment",user:r.activeUser.id});$(".pickers").hide()};e.updateProduct=function(){c.child("lines").child(p).child("product").set({custom_price:e.clickedLine.product.custom_price,quantity:e.clickedLine.product.quantity,title:e.clickedLine.product.title,currency:e.clickedLine.product.currency,price:e.clickedLine.product.price,tax:e.clickedLine.product.tax});var t=e.users[r.activeUser.id].first_name+" updated the product.";c.child("lines").child(p).child("comments").push({comment:t,type:"update",user:r.activeUser.id});typeof e.clickedLine.comment!="undefined"&&e.clickedLine.comment!==""&&c.child("lines").child(p).child("comments").push({comment:e.clickedLine.comment,type:"comment",user:r.activeUser.id});e.hidePickers()}}]);